name: CI

# Prerequisites:
# 1. Run scripts/setup-github-oidc.py locally to create OIDC provider and IAM role
# 2. Add AWS_ROLE_ARN secret to GitHub repository
# 3. Add AWS_ACCOUNT_ID variable to GitHub repository
# No static AWS credentials needed - uses OIDC for authentication

on:
  push:
    branches: ["**"] # Run on all branches
  pull_request:
    branches: [main] # Only PRs to main
  workflow_dispatch:
    inputs:
      run_deploy:
        description: 'Run CDK deployment'
        required: false
        type: boolean
        default: false
      run_integration:
        description: 'Run integration tests (requires deployment)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"
  AWS_REGION: "us-east-1"
  # GitHub environment determines which AWS account to use (production or sandbox)
  # main â†’ production environment (AWS account 712672311059)
  # others â†’ sandbox environment (AWS account 521690816501)
  GITHUB_ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'sandbox' }}
  # CDK deployment environment (for RemovalPolicy logic)
  # main â†’ production (RETAIN resources), others â†’ ci (DESTROY resources)
  ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'ci' }}

# Required for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install ruff --system

      - name: Run Ruff linter
        run: ruff check src/ tests/

      - name: Run Ruff formatter check
        run: ruff format --check src/ tests/

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install -e ".[dev]" --system

      - name: Run unit tests with coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-report=term-missing -m "not integration"
        env:
          AGENT_METADATA_TABLE: AgentMetadata
          AGENT_STATUS_TABLE: AgentStatus

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false

      - name: Upload unit test coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage
          path: coverage.xml
          retention-days: 30

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install -e ".[dev]" mypy types-boto3 --system

      - name: Run mypy
        run: mypy src/ --ignore-missing-imports

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install bandit pip-audit --system

      - name: Run Bandit security linter
        run: bandit -r src/ -ll -ii || true
        continue-on-error: true

      - name: Check dependencies for vulnerabilities
        run: pip-audit || true
        continue-on-error: true

  cdk-synth:
    name: CDK Synth
    runs-on: ubuntu-latest
    needs: test
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'sandbox' }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-CDKSynth
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python dependencies
        run: uv pip install -e ".[dev]" aws-cdk-lib constructs --system

      - name: CDK Synth
        run: |
          cd infrastructure/cdk
          cdk synth --all
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

  cdk-deploy:
    name: CDK Deploy
    runs-on: ubuntu-latest
    needs: [lint, test, type-check, cdk-synth]
    # Run on PRs, commit message tags, or manual trigger
    if: github.event_name == 'pull_request' || contains(github.event.head_commit.message, '[deploy]') || contains(github.event.head_commit.message, '[integration]') || inputs.run_deploy || inputs.run_integration
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'sandbox' }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-CDKDeploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python dependencies
        run: uv pip install -e ".[dev]" aws-cdk-lib constructs --system

      - name: CDK Deploy
        run: |
          cd infrastructure/cdk
          cdk deploy --all --require-approval never --outputs-file outputs.json
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

      - name: Upload CDK outputs
        uses: actions/upload-artifact@v4
        with:
          name: cdk-outputs
          path: infrastructure/cdk/outputs.json
          retention-days: 1

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: cdk-deploy
    # Run on PRs, commit message tags, or manual trigger
    if: github.event_name == 'pull_request' || contains(github.event.head_commit.message, '[deploy]') || contains(github.event.head_commit.message, '[integration]') || inputs.run_integration
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'sandbox' }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-IntegrationTest
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install -e ".[dev]" --system

      - name: Download CDK outputs
        uses: actions/download-artifact@v4
        with:
          name: cdk-outputs
          path: infrastructure/cdk

      - name: Extract API URL from outputs
        id: extract-api-url
        run: |
          # Parse the API URL from CDK outputs
          # The outputs file structure is: { "StackName": { "OutputKey": "OutputValue" } }
          API_URL=$(cat infrastructure/cdk/outputs.json | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          # Find the API stack (name contains 'API')
          for stack_name, outputs in data.items():
              if 'API' in stack_name:
                  for key, value in outputs.items():
                      if 'ApiUrl' in key:
                          print(value.rstrip('/'))
                          sys.exit(0)
          print('API_URL not found in outputs', file=sys.stderr)
          sys.exit(1)
          ")
          echo "API_URL=$API_URL" >> $GITHUB_OUTPUT
          echo "ðŸ”— API URL: $API_URL"

      - name: Run integration tests
        run: |
          # Integration tests use 60% threshold (vs 80% for unit tests)
          # Industry standard: integration tests 70-80%, unit tests 80-95%
          pytest -v -m integration --cov=src --cov-report=xml --cov-report=term-missing --cov-fail-under=60
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ env.AWS_REGION }}
          API_URL: ${{ steps.extract-api-url.outputs.API_URL }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: integration
          fail_ci_if_error: false

      - name: Upload integration test coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: integration-coverage
          path: coverage.xml
          retention-days: 30

      - name: Cleanup test data (main branch only)
        if: github.ref == 'refs/heads/main'
        run: |
          pip install boto3
          python scripts/cleanup_test_data.py
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

  cdk-destroy:
    name: CDK Destroy (Cleanup)
    runs-on: ubuntu-latest
    needs: [cdk-deploy, integration-test]
    environment: sandbox
    # Run cleanup whenever deploy was attempted (success or failure)
    # Ensures full resource cleanup even if deploy fails partway
    # Environment-based removal policy (DESTROY in CI) handles table deletion
    # SKIP on main branch (production environment) to retain resources
    if: always() && needs.cdk-deploy.result != 'skipped' && github.ref != 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-CDKDestroy
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python dependencies
        run: uv pip install -e ".[dev]" aws-cdk-lib constructs --system

      - name: CDK Destroy
        run: |
          cd infrastructure/cdk
          cdk destroy --all --force
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, test, type-check, security]
    # Don't require CDK synth since it may be skipped
    if: always()
    steps:
      - name: Check required jobs
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "Lint failed"
            exit 1
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "Test failed"
            exit 1
          fi
          if [[ "${{ needs.type-check.result }}" != "success" ]]; then
            echo "Type check failed"
            exit 1
          fi
          if [[ "${{ needs.security.result }}" != "success" ]]; then
            echo "Security scan failed"
            exit 1
          fi
          echo "All required checks passed!"
