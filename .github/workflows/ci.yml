name: CI

# Prerequisites:
# 1. Run scripts/setup-github-oidc.py locally to create OIDC provider and IAM role
# 2. Add AWS_ROLE_ARN secret to GitHub repository
# 3. Add AWS_ACCOUNT_ID variable to GitHub repository
# No static AWS credentials needed - uses OIDC for authentication

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  AWS_REGION: "us-east-1"

# Required for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Ruff linter
        run: ruff check src/ tests/

      - name: Run Ruff formatter check
        run: ruff format --check src/ tests/

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests with coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-report=term-missing -m "not integration"
        env:
          AGENT_METADATA_TABLE: AgentMetadata
          AGENT_STATUS_TABLE: AgentStatus

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install mypy types-boto3

      - name: Run mypy
        run: mypy src/ --ignore-missing-imports

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit pip-audit

      - name: Run Bandit security linter
        run: bandit -r src/ -ll -ii || true
        continue-on-error: true

      - name: Check dependencies for vulnerabilities
        run: pip-audit || true
        continue-on-error: true

  cdk-synth:
    name: CDK Synth
    runs-on: ubuntu-latest
    needs: test
    # Only run CDK synth if AWS credentials are configured
    if: vars.AWS_ACCOUNT_ID != ''
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-CDKSynth
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install aws-cdk-lib constructs

      - name: CDK Synth
        run: |
          cd infrastructure/cdk
          cdk synth --all
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

  # CDK synth without AWS credentials (for PRs from forks)
  cdk-synth-local:
    name: CDK Synth (Local)
    runs-on: ubuntu-latest
    needs: test
    # Run local synth if AWS credentials are not configured
    if: vars.AWS_ACCOUNT_ID == ''
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install aws-cdk-lib constructs

      - name: CDK Synth (mock account)
        run: |
          cd infrastructure/cdk
          cdk synth --all
        env:
          AWS_ACCOUNT_ID: "123456789012"
          AWS_REGION: us-east-1

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, test, type-check, security]
    # Don't require CDK synth since it may be skipped
    if: always()
    steps:
      - name: Check required jobs
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "Lint failed"
            exit 1
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "Test failed"
            exit 1
          fi
          if [[ "${{ needs.type-check.result }}" != "success" ]]; then
            echo "Type check failed"
            exit 1
          fi
          if [[ "${{ needs.security.result }}" != "success" ]]; then
            echo "Security scan failed"
            exit 1
          fi
          echo "All required checks passed!"
