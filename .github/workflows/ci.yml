name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  AWS_REGION: "us-east-1"

# Required for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install ruff --system

      - name: Run Ruff linter
        run: ruff check src/ tests/

      - name: Run Ruff formatter check
        run: ruff format --check src/ tests/

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install -e ".[dev]" --system

      - name: Run unit tests with coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-report=term-missing -m "not integration"
        env:
          AGENT_METADATA_TABLE: AgentMetadata
          AGENT_STATUS_TABLE: AgentStatus

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false

      - name: Upload unit test coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage
          path: coverage.xml
          retention-days: 30

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install -e ".[dev]" mypy types-boto3 --system

      - name: Run mypy
        run: mypy src/ --ignore-missing-imports --no-error-summary || true
        continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install bandit pip-audit --system

      - name: Run Bandit security linter
        run: bandit -r src/ -ll -ii || true
        continue-on-error: true

      - name: Check dependencies for vulnerabilities
        run: pip-audit || true
        continue-on-error: true

  cdk-synth:
    name: CDK Synth
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-CDKSynth
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python dependencies
        run: uv pip install -e ".[dev]" aws-cdk-lib constructs --system

      - name: CDK Synth
        run: |
          cd infrastructure/cdk
          cdk synth --all
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

  cdk-deploy:
    name: CDK Deploy
    runs-on: ubuntu-latest
    needs: [lint, test, type-check, cdk-synth]
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-CDKDeploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python dependencies
        run: uv pip install -e ".[dev]" aws-cdk-lib constructs --system

      - name: CDK Deploy
        run: |
          cd infrastructure/cdk
          cdk deploy --all --require-approval never
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: cdk-deploy
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-IntegrationTest
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install -e ".[dev]" --system

      - name: Run integration tests
        run: |
          pytest -v -m integration --cov=src --cov-report=xml --cov-report=term-missing
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: integration
          fail_ci_if_error: false

      - name: Upload integration test coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: integration-coverage
          path: coverage.xml
          retention-days: 30

  cdk-destroy:
    name: CDK Destroy (Cleanup)
    runs-on: ubuntu-latest
    needs: [cdk-deploy, integration-test]
    # Run cleanup whenever deploy was attempted (success or failure)
    # Ensures full resource cleanup even if deploy fails partway
    # Environment-based removal policy (DESTROY in CI) handles table deletion
    if: always() && needs.cdk-deploy.result != 'skipped'
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-CDKDestroy
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python dependencies
        run: uv pip install -e ".[dev]" aws-cdk-lib constructs --system

      - name: CDK Destroy
        run: |
          cd infrastructure/cdk
          cdk destroy --all --force
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, test, type-check, security]
    # Don't require CDK synth since it may be skipped
    if: always()
    steps:
      - name: Check required jobs
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "Lint failed"
            exit 1
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "Test failed"
            exit 1
          fi
          if [[ "${{ needs.type-check.result }}" != "success" ]]; then
            echo "Type check failed"
            exit 1
          fi
          if [[ "${{ needs.security.result }}" != "success" ]]; then
            echo "Security scan failed"
            exit 1
          fi
          echo "All required checks passed!"
